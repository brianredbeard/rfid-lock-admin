{% extends "admin/change_form.html" %}
{% load custom_filters %}
{% load i18n admin_urls %}


{% comment %} 
    If this is an RFIDkeycard inline/popup (http://localhost:8080/lockadmin/djock_app/rfidkeycard/add/?_popup=1), insert some extra temporary text 
{% endcomment %} 
{% block object-tools %}

    {% comment %} {% if request.path == "/lockadmin/djock_app/rfidkeycard/add/" and request.META.QUERY_STRING == "_popup=1"  %} {% endcomment %} 
    {% if request.path == "/lockadmin/djock_app/rfidkeycard/add/" and is_popup  %}
            <center style="background-color:#fdd;">

            <p style="font-size:10px; color:#666;width:700px;">
            (This popup should go away; then the change_form should refresh so that superusers see the number there and non-superusers don't see the number but see the other signs that mean that a keycard is assigned and is active, like the place by "Manage keycard" that says whether or not lock user has an active keycard, and which options of "assign new keycard" and "deactivate current keycard" are functional.
            <p>
            <p style="font-size:10px; color:#777;width:700px; ">
            Note that the "Save" is really "Save and Assign" - the association with this LockUser already happens by the time back at the form.
            Also, since manage keycards stuff will actually be below everything else and the save bar -- i.e. saving everything else about the
            lockuser is a separate thing.... so that refreshing when come back out of the popup doesn't screw things up/lose things.  The manage
            keycards bar will now reflect that that user now has active keycard. The superuser should see the fields listing current and all
            rfid's have changed.)
            <p>
            </center>
            <hr>
            
            <hr>
            <center>
            <h2>Go scan in a new card........</h2>
            <h5>..................... waiting .....................</h3>
            <h5>(Be the Arduino and go to</h5>
            <p>http://192.168.x.x:8080/checkdoor/doorid/checkrfid/rfid/ (if ran ./manage.py runserver 192.168.x.x:8080)</p>
            <h5> OK, got it. Click "Save" to finish creating new keycard.</h5>
            </center>
    {% endif %} {% comment %} end nk for this block {% endcomment %}
    {% if change %}{% if not is_popup %}
        <ul class="object-tools">
            {% block object-tools-items %} {{block.super}} {% endblock %}
        </ul>
    {% endif %}{% endif %}
{% endblock %} {% comment %}  end object-tools block  {% endcomment %}







{% comment %}  submit row block {% endcomment %}
{% block submit_buttons_bottom %}
    {% comment %} (start nk stuff)  This is the place for the "assign new keycard"/"deactivate current keycard" controls, if this is the LockUser change form {% endcomment %}

        {% comment %} Check:  that we're modifying a model, rather than creating it (so not model/add/ but model/object_id); also check if we're dealing with LockUser  {% endcomment %}
        {% if change and original|get_object_type == "LockUser" %}<br>
                    
        <div class="submit-row"> 
                {% comment %} using STATIC_URL for *my* static/ files; otherwise it's Django admin's originals {% endcomment %}
                 {% if  not object_id|is_lockuser_active %} 
                    {% comment %} 
                        <a href="/lockadmin/djock_app/rfidkeycard/add/" class="add-another" id="add_id_rfids_40" onclick="return showAddAnotherPopup(this);">
                    {% endcomment %} 
                    <a href="/lockadmin/djock_app/rfidkeycard/add/">
                        <img src="/static/admin/img/icon_addlink.gif" width="10" height="10" alt="Add Another"/> Assign keycard and activate user 
                    </a>
                    <img src="{{ STATIC_URL }}/admin/img/disabled_icon_deletelink.gif " width="10" height="10" readonly>Deactivate current keycard

                 {% elif  object_id|is_lockuser_active and not object_id|does_lockuser_have_active_keycard %}
                {% comment %} 
                    <a href="/lockadmin/djock_app/rfidkeycard/add/" class="add-another" id="add_id_rfids" onclick="return showAddAnotherPopup(this);">
                {% endcomment %} 
                    <a href="/lockadmin/djock_app/rfidkeycard/add/">
                        <img src="/static/admin/img/icon_addlink.gif" width="10" height="10" alt="Add Another"/> Assign new keycard 
                    </a>
                    <img src="{{ STATIC_URL }}/admin/img/disabled_icon_deletelink.gif" width="10" height="10">Deactivate current keycard

                 {% elif  object_id|is_lockuser_active and object_id|does_lockuser_have_active_keycard %} 
                    <img src="{{ STATIC_URL }}/admin/img/disabled_icon_addlink.gif" width="10" height="10" alt="Add Another"/> Assign new keycard
                {% comment %} 
                    <a href="/" class="add-another" id="add_id_rfids" onclick="return showAddAnotherPopup(this);"> 
                {% endcomment %} 
                    <a href="/">
                        <img src="/static/admin/img/icon_deletelink.gif " width="10" height="10"> Deactivate current keycard 
                    </a>
                 {% endif %}
                    </div> {% comment %} end nk submit-row {% endcomment %}
    {%  endif  %}
    </div> 
     {{ block.super }}
{% endblock %}   {% comment %}  end submit row block {% endcomment %}



{% comment %} overriding this block in order to show the controls for assigning new keycards/deactivating existing ones in the form row {% endcomment %} 

{% comment %}
    {% block field_sets %}
        {% for fieldset in adminform %}
            overriding this block.. unless i can actually get fieldset into the right dir....
            {% include "admin/includes/fieldset.html" %}
        {% endfor %}
    {% endblock %}
{% endcomment %}




{% comment %}
;
{% block object-tools %}
{% if change %}{% if not is_popup %}
<div style="text-align:center;">
    <a href="../../fake/" class="btn btn-info btn-large" style="color:white; margin:10px auto ">Fake assign keycard<br>(== scanning a new keycard and getting the number)</a> 
    <a href="" class="btn btn-info btn-large disabled" style="color:white; margin:10px auto ">
    Deactivate keycard
    </a> 
</div>
<ul class="object-tools">
    {% block object-tools-items %} {{block.super}} {% endblock %}
</ul>
{% endif %}{% endif %}
{% endblock %}

{% endcomment %}



{% comment %}
MORE OR LESS DEPRECATED BRAINVOMIT:

The best thing would be to override the block with the save, etc. buttons at the bottom... But, that's harder than it sounds (solutions involve hacky stuff with javascript!).  Or that's what people on the internet think.  But here's what you can do, I think: submit_row is a template tag.  Look at the code for that, and create your own custom template tag that's similar but includes the extra behavior. 
{% block submit_buttons_bottom %}{% submit_row %}{% endblock %}


{% block submit_buttons_bottom %}
Or move in here? 
     {{block.super}}
{% endblock %}
{% endcomment %}
